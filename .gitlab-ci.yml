stages:
 - source_check
 - build
 - test

variables:
    JS_LOG: "js-report.txt"
    POT_LOG: "pot-update.txt"

js_check:
    image: registry.fedoraproject.org/fedora:latest
    stage: source_check
    before_script:
        - dnf install -y findutils mozjs60-devel
    script:
        - find js -name '*.js' -exec js60 -c -s '{}' ';' 2>&1 | tee $JS_LOG
        - (! grep -q . $JS_LOG)
    only:
        changes:
            - js/**/*
    artifacts:
        paths:
            - ${JS_LOG}
        when: on_failure

build:
    image: registry.gitlab.gnome.org/gnome/mutter/master:v1
    stage: build
    before_script:
        # non-mutter build dependencies
        - dnf builddep -y gnome-shell
        - dnf remove -y mutter
        # check out mutter ...
        - git clone https://gitlab.gnome.org/GNOME/mutter.git
        - cd mutter
        # ... either at the branch matching the MR, or master ...
        - MUTTER_BRANCH=origin/${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME:-master}
        - MUTTER_BRANCH=$(git branch -r -l $MUTTER_BRANCH)
        - git checkout ${MUTTER_BRANCH:-origin/master}
        # ... and build it
        - meson . build --prefix=/usr -Dtests=false
        - ninja -C build
        - ninja -C build install
        - cd ..
    script:
        - meson . build -Dbuiltype=debugoptimized
        - ninja -C build
        - ninja -C build install
    artifacts:
        expire_in: 1 day
        paths:
            - mutter
            - build

test:
    image: registry.gitlab.gnome.org/gnome/mutter/master:v1
    stage: test
    dependencies:
        - build
    before_script:
        - dnf builddep -y gnome-shell
        - dnf remove -y mutter
        - dnf install -y '*/xvfb-run' '*/Gdm-1.0.typelib'
        - ninja -C mutter/build install
    script:
        - xvfb-run meson test -C build --no-rebuild
    artifacts:
        expire_in: 1 day
        paths:
            - build/meson-logs/testlog.txt
        when: on_failure

test-pot:
    image: registry.gitlab.gnome.org/gnome/mutter/master:v1
    stage: test
    dependencies:
        - build
    script:
        # Check that pot files are generated correctly:
        # https://savannah.gnu.org/bugs/?50920#comment5
        - ninja -C build -v gnome-shell-pot
        - ninja -C build gnome-shell-pot 2>&1 | awk '
            BEGIN { start=0; }
            start==1 { print $0; }
            /gnome-shell-pot/ { start=1; }
          ' | tee $POT_LOG
        - (! grep -q . $POT_LOG)
