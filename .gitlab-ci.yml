stages:
 - review
 - source_check
 - build

variables:
    JS_LOG: "js-report.txt"

.only_default: &only_default
    only:
        - branches
        - tags
        - merge_requests

check_commit_log:
    image: registry.fedoraproject.org/fedora:latest
    stage: review
    before_script:
        - dnf install -y git
    script:
        - ./.gitlab-ci/check-commit-log.sh
    only:
        - merge_requests

js_check:
    image: registry.fedoraproject.org/fedora:latest
    stage: source_check
    before_script:
        - dnf install -y findutils mozjs60-devel
    script:
        - find js -name '*.js' -exec js60 -c -s '{}' ';' 2>&1 | tee $JS_LOG
        - (! grep -q . $JS_LOG)
    <<: *only_default
    only:
        changes:
            - js/**/*
    artifacts:
        paths:
            - ${JS_LOG}
        when: on_failure

build:
    image: registry.gitlab.gnome.org/gnome/gnome-shell/master:v1
    stage: build
    before_script:
        - .gitlab-ci/checkout-mutter.sh
        - meson mutter mutter/build --prefix=/usr -Dtests=false
        - ninja -C mutter/build install
    script:
        - meson . build -Dbuiltype=debugoptimized
        - ninja -C build
        - ninja -C build install
    <<: *only_default
